name: Build & Release

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  repository_dispatch:
    types: [upstream_update]

env:
  UPSTREAM_REPO: takagen99/Box
  UPSTREAM_BRANCH: main
  BUILD_VARIANTS: "assembleArm64GenericNormalRelease assembleArmeabiGenericNormalRelease"
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync upstream
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          git fetch upstream
          echo "UPSTREAM_COMMIT=$(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})" >> $GITHUB_ENV
          echo "UPSTREAM_MSG=$(git log upstream/${{ env.UPSTREAM_BRANCH }} -1 --pretty=format:'%s')" >> $GITHUB_ENV
          mv .github /tmp/.github_backup
          rm -rf *
          mv /tmp/.github_backup .github
          git checkout upstream/${{ env.UPSTREAM_BRANCH }} -- .

      - name: Generate version
        run: |
          echo "VERSION=v$(date +'%Y%m%d_%H%M')" >> $GITHUB_ENV

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - uses: android-actions/setup-android@v2
      - uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Apply patches
        run: |
          python3 ${{ github.workspace }}/.github/scripts/001_patch_m3u_logo_extract.py
          python3 ${{ github.workspace }}/.github/scripts/002_patch_m3u_logo_priority.py

      - name: Build
        run: |
          echo "sdk.dir=$ANDROID_HOME" > local.properties
          mkdir -p ~/.android
          keytool -genkey -v -keystore ~/.android/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          python3 ${{ github.workspace }}/.github/scripts/configure_signing.py
          chmod +x gradlew
          ./gradlew ${{ env.BUILD_VARIANTS }} --build-cache --parallel --daemon --warning-mode none

      - name: Prepare APKs
        run: |
          mkdir -p ${{ github.workspace }}/apk/
          echo "=== Debug: Listing all APK files ==="
          find app/build/outputs/apk -name "*.apk" -type f
          echo "=== Debug: APK directory structure ==="
          ls -la app/build/outputs/apk/*/
          
          cd app/build/outputs/apk
          for apk in $(find . -name "*.apk" -type f); do
            echo "Processing: $apk"
            # 从路径中提取架构名称
            if [[ "$apk" == *"arm64"* ]]; then
              arch_name="arm64"
            elif [[ "$apk" == *"armeabi"* ]]; then
              arch_name="armeabi"
            else
              arch_name="unknown"
            fi
            echo "Architecture: $arch_name"
            cp "$apk" "${{ github.workspace }}/apk/TVBox_Patch_${arch_name}_${{ env.VERSION }}.apk"
          done
          
          echo "=== Debug: Final APK files ==="
          ls -la ${{ github.workspace }}/apk/

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: "${{ env.VERSION }} (${{ env.UPSTREAM_COMMIT }})"
          body: |
            ## 版本信息
            - **版本号**: ${{ env.VERSION }}
            - **上游 Commit**: [${{ env.UPSTREAM_COMMIT }}](https://github.com/${{ env.UPSTREAM_REPO }}/commit/${{ env.UPSTREAM_COMMIT }})
            - **上游修改**: ${{ env.UPSTREAM_MSG }}

            ## 修改内容
            - ✅ M3U Logo 支持

            ## 下载
            | 文件名 | 架构 |
            |--------|------|
            | TVBox_Patch_arm64_${{ env.VERSION }}.apk | ARM64 |
            | TVBox_Patch_armeabi_${{ env.VERSION }}.apk | ARM32 |
          files: ${{ github.workspace }}/apk/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
